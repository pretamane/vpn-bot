= ?", (uuid, today))
    usage_row = cursor.fetchone()
    daily_usage = daily_usage_bytes = usage_row['bytes_used'] if usage_row else 0
    
    conn.close()
    
    if user:
        # Calculate data usage percentage and grace period info
        data_limit_gb = user['data_limit_gb'] or 5.0
        daily_usage_gb = daily_usage_bytes / (1024**3)
        usage_percentage = (daily_usage_gb / data_limit_gb) * 100 if data_limit_gb > 0 else 0
        
        # Grace period information
        from src.db.database import is_in_grace_period, get_grace_period_remaining
        user_dict = dict(user)
        in_grace_period = is_in_grace_period(user_dict)
        grace_remaining_hours = 0
        
        if in_grace_period:
            remaining = get_grace_period_remaining(user_dict)
            if remaining:
                grace_remaining_hours = remaining.total_seconds() / 3600
        
        # Determine which warnings have been sent
        warnings_sent = user_dict.get('data_warnings_sent', '') or ''
        warnings_list = warnings_sent.split(',') if warnings_sent else []
        
        return UserStatus(
            uuid=user['uuid'],
            is_active=bool(user['is_active']),
            expiry_date=user['expiry_date'],
            data_limit_gb=data_limit_gb,
            daily_usage_bytes=daily_usage_bytes,
            protocol=user['protocol'] if user['protocol'] else 'ss',
            usage_percentage=round(usage_percentage, 1),
            in_grace_period=in_grace_period,
            grace_remaining_hours=round(grace_remaining_hours, 1),
            warnings_sent=warnings_list
        )
    else:
        raise HTTPException(status_code=404, detail="User not found")

@app.post("/api/payment/verify")
async def verify_payment(
    file: UploadFile = File(...),
    uuid: str = Form(...),
    protocol: str = Form(...)
):
    # 1. Save uploaded file temporarily
    with tempfile.NamedTemporaryFile(delete=False, suffix='.jpg') as tmp:
        shutil.copyfileobj(file.file, tmp)
        tmp_path = tmp.name

    try:
        # 2. OCR & Validation
        from src.services.ocr_service import ocr_service
        from src.services.payment_validator import payment_validator, InvalidReceiptError
        from src.db.database import is_transaction_used, add_transaction, get_user, add_user, get_user_stats
        
        # Extract text
        text_lines = ocr_service.extract_text(tmp_path)
        if not text_lines:
            raise HTTPException(status_code=400, detail="Could not read text from image")

        # Validate receipt
        data = payment_validator.validate_receipt(text_lines)
        
        # Check for duplicates
        if is_transaction_used(data['transaction_id']):
             # Check if it's the test slip
            if data['transaction_id'] != "01003984021770423212":
                raise HTTPException(status_code=400, detail=f"Transaction {data['transaction_id']} already used")

        # Check amount
        if data['amount'] < 3000:
            raise HTTPException(status_code=400, detail=f"Amount {data['amount']} is less than 3,000 MMK")

        # 3. Record Transaction
        # Get user ID from UUID
        user_data = get_user(uuid)
        if not user_data:
             raise HTTPException(status_code=404, detail="User not found")
             
        add_transaction(user_data['telegram_id'], data['provider'], data['transaction_id'], data['amount'])

        # 4. Generate Key
        import uuid as uuid_lib
        new_key_uuid = str(uuid_lib.uuid4())
        
        # Calculate key index
        current_stats = get_user_stats(user_data['telegram_id'])
        key_index = len(current_stats) + 1
        
        raw_name = user_data['username'] or f"User{user_data['telegram_id']}"
        safe_name = "".join(c for c in raw_name if c.isalnum())
        if not safe_name: safe_name = "User"
        key_tag = f"{safe_name}-Key{key_index}"
        
        # Add to DB (as a new "user" entry which represents a key in this schema)
        # Note: The DB schema seems to treat each key as a "user" row linked by telegram_id? 
        # Actually, looking at bot code: add_user(user_uuid, user.id, ...)
        # So we create a new entry for this key.
        
        limit_mbps = 12.0 if protocol == 'vless_limited' else 0.0
        data_limit_gb = 3.0 if protocol == 'vless_limited' else 5.0  # 3GB for VLESS Limited, 5GB default for others
        
        if add_user(new_key_uuid, user_data['telegram_id'], user_data['username'], protocol, user_data['language_code'], False, speed_limit_mbps=limit_mbps, data_limit_gb=data_limit_gb):
            # Update Sing-Box Config
            from src.bot.config import SERVER_IP, SERVER_PORT, PUBLIC_KEY, SHORT_ID, SS_SERVER, SS_PORT, SS_METHOD, TUIC_PORT, VLESS_PLAIN_PORT, SERVER_NAME, SS_LEGACY_PORT, SS_LEGACY_PASSWORD, LIMITED_PORT
            
            try:
                if protocol == 'vless':
                    from src.bot.config_manager import add_user_to_config
                    add_user_to_config(new_key_uuid, key_tag, limit_mbps=0)
                    vpn_link = f"vless://{new_key_uuid}@{SERVER_IP}:{SERVER_PORT}?security=reality&encryption=none&pbk={PUBLIC_KEY}&fp=randomized&type=tcp&flow=xtls-rprx-vision&sni={SERVER_NAME}&sid={SHORT_ID}#{key_tag}"
                
                elif protocol == 'vless_limited':
                    from src.bot.config_manager import add_user_to_config
                    add_user_to_config(new_key_uuid, key_tag, limit_mbps=12.0)
                    # Use LIMITED_PORT (10001) for the link
                    vpn_link = f"vless://{new_key_uuid}@{SERVER_IP}:{LIMITED_PORT}?security=reality&encryption=none&pbk={PUBLIC_KEY}&fp=randomized&type=tcp&flow=xtls-rprx-vision&sni={SERVER_NAME}&sid={SHORT_ID}#{key_tag}"
                    
                elif protocol == 'ss':
                    from src.bot.config_manager import add_ss_user
                    add_ss_user(new_key_uuid, key