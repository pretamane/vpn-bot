import sqlite3
from fastapi import FastAPI, HTTPException, Body, UploadFile, File, Form
from pydantic import BaseModel
import shutil
import tempfile
import os
import uvicorn
import uuid
from google.oauth2 import id_token
from google.auth.transport import requests
from src.db.database import get_user_by_email, add_user, get_user

# Database setup
DB_PATH = os.getenv("DB_PATH", "src/db/vpn_bot.db")
API_PORT = int(os.getenv("API_PORT", "8000"))
# CLIENT_ID should be loaded from env or config, but for now we can accept any valid token for this app
# In production, you MUST verify the aud claim matches your client ID.
GOOGLE_CLIENT_ID = os.getenv("GOOGLE_CLIENT_ID") 

app = FastAPI(title="MMVPN API")

class UserStatus(BaseModel):
    uuid: str
    is_active: bool
    expiry_date: str
    data_limit_gb: float
    daily_usage_bytes: int
    protocol: str
    usage_percentage: float = 0.0  # Percentage of data used (0-100+)
    in_grace_period: bool = False  # Whether user is in 24h grace period
    grace_remaining_hours: float = 0.0  # Hours remaining in grace period
    warnings_sent: list = []  # List of warning thresholds triggered (e.g., ['30', '65'])

class GoogleLoginRequest(BaseModel):
    token: str

class VpnKey(BaseModel):
    user_uuid: str
    key_name: str
    protocol: str
    server_address: str
    server_port: int
    key_uuid: str = None
    key_password: str = None
    config_link: str
    expires_at: str = None

class VpnKeyResponse(BaseModel):
    id: int
    user_uuid: str
    key_name: str
    protocol: str
    server_address: str
    server_port: int
    key_uuid: str
    key_password: str
    config_link: str
    is_active: bool
    created_at: str
    expires_at: str

def get_db_connection():
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

# VPN Keys API endpoints
@app.post("/api/keys")
async def save_vpn_key(key: VpnKey):
    """Save a VPN key for a specific user"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            INSERT INTO vpn_keys (user_uuid, key_name, protocol, server_address, server_port, 
                                  key_uuid, key_password, config_link, expires_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        """, (key.user_uuid, key.key_name, key.protocol, key.server_address, key.server_port,
              key.key_uuid, key.key_password, key.config_link, key.expires_at))
        conn.commit()
        return {"status": "success", "key_id": cursor.lastrowid}
    except Exception as e:
        conn.rollback()
        raise HTTPException(status_code=500, detail=f"Failed to save key: {str(e)}")
    finally:
        conn.close()

@app.get("/api/keys/{user_uuid}")
async def get_user_keys(user_uuid: str):
    """Get all VPN keys for a specific user"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            SELECT id, user_uuid, key_name, protocol, server_address, server_port,
                   key_uuid, key_password, config_link, is_active, 
                   created_at, expires_at
            FROM vpn_keys 
            WHERE user_uuid = ? AND is_active = 1
            ORDER BY created_at DESC
        """, (user_uuid,))
        keys = cursor.fetchall()
        return {"keys": [dict(k) for k in keys]}
    finally:
        conn.close()

@app.delete("/api/keys/{key_id}")
async def delete_vpn_key(key_id: int, user_uuid: str):
    """Delete a VPN key (soft delete by setting is_active=0)"""
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute("""
            UPDATE vpn_keys SET is_active = 0 
            WHERE id = ? AND user_uuid = ?
        """, (key_id, user_uuid))
        conn.commit()
        if cursor.rowcount == 0:
            raise HTTPException(status_code=404, detail="Key not found or not authorized")
        return {"status": "deleted"}
    finally:
        conn.close()


@app.post("/api/auth/google")
async def google_login(request: GoogleLoginRequest):
    try:
        # Verify the token
        id_info = id_token.verify_oauth2_token(
            request.token, 
            requests.Request(), 
            GOOGLE_CLIENT_ID,
            clock_skew_in_seconds=60
        )
        email = id_info.get('email')
        if not email:
            raise HTTPException(status_code=400, detail="Token does not contain email")
            
        # Check if user exists
        user = get_user_by_email(email)
        
        if user:
            user_uuid = user['uuid']
        else:
            # Create new user
            user_uuid = str(uuid.uuid4())
            # Default values for new users
            success = add_user(
                uuid=user_uuid,
                telegram_id=0, # No telegram ID for Google users initially
                username=email.split('@')[0],
                email=email,
                protocol='vless', # Default to VLESS for app users
                expiry_days=30,
                is_premium=False
            )
            if not success:
                raise HTTPException(status_code=500, detail="Failed to create user")

        return {"uuid": user_uuid, "email": email}

    except ValueError as e:
        print(f"Token verification failed: {e}")
        raise HTTPException(status_code=401, detail=f"Invalid token: {str(e)}")
    except Exception as e:
        print(f"Server error: {e}")
        raise HTTPException(status_code=500, detail=f"Internal server error: {str(e)}")

@app.get("/api/status/{uuid}", response_model=UserStatus)
async def get_user_status(uuid: str):
    conn = get_db_connection()
    cursor = conn.cursor()
    
    # Query for the user
    cursor.execute("SELECT * FROM users WHERE uuid = ?", (uuid,))
    user = cursor.fetchone()
    
    # Query for daily usage
    from datetime import datetime
    today = datetime.now().date().isoformat()
    cursor.execute("SELECT bytes_used FROM usage_logs WHERE uuid = ? AND date 