import logging
import uuid
import qrcode
import io
import sys
import os
import tempfile

# Add parent directory to path to import db
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackQueryHandler
from db.database import add_user, get_user, init_db, get_active_key_count, get_user_stats, get_all_users, delete_user, activate_user, deactivate_user
from bot.config import BOT_TOKEN, KBZ_PAY_NUMBER, WAVE_PAY_NUMBER, SERVER_IP, PUBLIC_KEY, SHORT_ID, SERVER_PORT, SERVER_NAME, SS_SERVER, SS_PORT, SS_METHOD, SS_PASSWORD, SS_LEGACY_PORT, SS_LEGACY_PASSWORD, TUIC_PORT, VLESS_PLAIN_PORT, MAX_KEYS_PER_USER, ADMIN_ID, ADMIN_PASSWORD, ADMIN_USERNAME

# Enable logging
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)

# Initialize NSFW detector (lazy load to avoid startup delay)
nsfw_detector = None

def get_nsfw_detector():
    global nsfw_detector
    if nsfw_detector is None:
        try:
            from nudenet import NudeDetector
            nsfw_detector = NudeDetector()
            logger.info("NudeNet detector initialized successfully")
        except Exception as e:
            logger.error(f"Failed to initialize NudeNet: {e}")
            nsfw_detector = False  # Mark as failed to avoid retrying
    return nsfw_detector if nsfw_detector is not False else None

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Send a message when the command /start is issued."""
    user = update.effective_user
    keyboard = [
        [InlineKeyboardButton("[Buy] Buy VPN Key", callback_data="menu_buy")],
        [InlineKeyboardButton("[Status] My Status", callback_data="menu_status")],
        [InlineKeyboardButton("[Help] Help & Support", callback_data="menu_help")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_html(
        f"Welcome {user.mention_html()}! [MM]\n\n"
        "[+] 12 Mbps speed | 5 GB/day | 1 device/key\n"
        "[$] Price: 3,000 MMK/month\n\n"
        "Select an option below:",
        reply_markup=reply_markup
    )

async def handle_protocol_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle protocol selection."""
    query = update.callback_query
    await query.answer()
    
    # Check if admin TUIC selected
    if query.data == "protocol_admin_tuic":
        context.user_data['protocol'] = 'admin_tuic'
        context.user_data['awaiting_admin_password'] = True
        await query.edit_message_text(
            "🔐 **Admin-Only Protocol Selected**\n\n"
            "This is ThawZin's dedicated India TUIC server.\n"
            "Please enter the admin password:",
            parse_mode="Markdown"
        )
        return
    
    protocol = query.data.split("_", 1)[1]  # "ss", "vless", "tuic", "vlessplain", "ss_legacy"
    context.user_data['protocol'] = protocol
    
    # Map protocol codes to display names
    protocol_map = {
        "ss": "Shadowsocks (9388) -> Sing-Box",
        "vless": "VLESS Reality (Unlimited) -> Sing-Box",
        "vless_limited": "VLESS Limited (12 Mbps) -> Sing-Box",
        "tuic": "TUIC-Server (2083) -> Sing-Box",
        "vlessplain": "VLESS + TLS (8444) -> Sing-Box",
        "ss_legacy": "Shadowsocks (8388) -> Sing-Box"
    }
    protocol_name = protocol_map.get(protocol, "Unknown")
    
    await query.edit_message_text(
        f"Selected: {protocol_name}\n\n"
        f"Please send 3,000 MMK to:\n\n"
        f"KBZ: {KBZ_PAY_NUMBER}\n"
        f"Wave: {WAVE_PAY_NUMBER}\n\n"
        "After payment, send a screenshot of success here."
    )

async def buy(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Send payment instructions and protocol selection."""
    keyboard = [
        [InlineKeyboardButton("VLESS Reality (Unlimited)", callback_data="protocol_vless")],
        [InlineKeyboardButton("VLESS Limited (12 Mbps)", callback_data="protocol_vless_limited")],
        [InlineKeyboardButton("ShadowSocks (9388) -> Sing-Box", callback_data="protocol_ss")],
        [InlineKeyboardButton("TUIC-Server (2083) -> Sing-Box", callback_data="protocol_tuic")],
        [InlineKeyboardButton("VLESS + TLS (8444) -> Sing-Box", callback_data="protocol_vlessplain")],
        [InlineKeyboardButton("ShadowSocks (8388) -> Sing-Box", callback_data="protocol_ss_legacy")],
        [InlineKeyboardButton("Admin TUIC (8443) -> TUIC-Server", callback_data="protocol_admin_tuic")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # Check if called from callback or command
    if update.callback_query:
        message_func = update.callback_query.message.reply_text
    else:
        message_func = update.message.reply_text
        
    await message_func(
        "Choose your VPN protocol:",
        reply_markup=reply_markup
    )

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Handle text messages (for admin password input)."""
    user = update.effective_user
    text = update.message.text
    
    # Check if awaiting admin password
    if context.user_data.get('awaiting_admin_password'):
        ADMIN_PASSWORD = "#ThawZin2k77!"
        
        if text == ADMIN_PASSWORD:
            # Password correct - generate admin TUIC key
            context.user_data['awaiting_admin_password'] = False
            
            import uuid as uuid_lib
            user_uuid = str(uuid_lib.uuid4())
            key_tag = f"{user.username or user.first_name}-AdminTUIC-{user.id}"
            
            # Generate TUIC link for legacy server on port 8443
            # This is the dedicated India server (legacy tuic-server)
            vpn_link = f"tuic://{user_uuid}:{user_uuid}@{SERVER_IP}:8443?congestion_control=bbr&alpn